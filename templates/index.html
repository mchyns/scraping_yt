{% extends "base.html" %}

{% block title %}Home - Scraping Komentar{% endblock %}

{% block content %}
<div class="card">
    <h2>Scraping Komentar YouTube</h2>
    <p style="color: #7f8c8d; margin-bottom: 20px;">Ambil komentar dari video YouTube untuk dianalisis</p>
    
    <div class="alert alert-error" id="error-message"></div>
    
    <form id="scrape-form">
        <div class="form-group">
            <label for="video-url">URL Video YouTube</label>
            <input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=..." required>
        </div>
        
        <div class="form-group">
            <label for="max-comments">Jumlah Komentar</label>
            <input type="number" id="max-comments" value="100" min="1" max="100000" required>
            <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                Maksimal 100,000 komentar. Semakin banyak semakin lama prosesnya.
            </small>
        </div>
        
        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="include-replies" style="width: auto; cursor: pointer;">
            <label for="include-replies" style="cursor: pointer; margin: 0;">
                Sertakan balasan komentar (replies)
            </label>
        </div>
        
        <button type="submit" class="btn" id="scrape-btn">Mulai Scraping</button>
    </form>
</div>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 10px;" id="loading-text">Mengambil komentar...</p>
    <div style="width: 300px; margin: 15px auto;">
        <div style="background: #ecf0f1; border-radius: 10px; overflow: hidden; height: 20px;">
            <div id="progress-bar" style="background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <p id="progress-text" style="margin-top: 5px; font-size: 14px; color: #7f8c8d;">0 / 0 komentar</p>
    </div>
</div>

<div class="card" id="result-section" style="display:none;">
    <h2>Hasil Scraping</h2>
    <div class="alert alert-success" id="save-message" style="display:none;"></div>
    <div id="video-info"></div>
    <div id="comments-preview"></div>
    <div style="margin-top: 20px;">
        <a href="/analysis" class="btn btn-success">Analisis Sentimen</a>
        <a href="/comments" class="btn btn-secondary">Lihat Semua Komentar</a>
    </div>
</div>

<script>
let progressInterval = null;

// Function to update progress bar
async function updateProgress() {
    try {
        const response = await fetch('/progress');
        const data = await response.json();
        
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const loadingText = document.getElementById('loading-text');
        
        if (data.total > 0) {
            const percentage = (data.current / data.total) * 100;
            progressBar.style.width = percentage + '%';
            
            // Show available comments info if known
            if (data.available && data.available > 0) {
                progressText.textContent = `${data.current} / ${data.total} komentar (tersedia: ${data.available})`;
            } else {
                progressText.textContent = `${data.current} / ${data.total} komentar`;
            }
            
            loadingText.textContent = data.message;
        }
        
        // Stop polling if completed or error
        if (data.status === 'completed' || data.status === 'error') {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    } catch (error) {
        console.error('Error fetching progress:', error);
    }
}

document.getElementById('scrape-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result-section').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
    document.getElementById('scrape-btn').disabled = true;
    
    // Reset progress
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').textContent = '0 / 0 komentar';
    document.getElementById('loading-text').textContent = 'Memulai scraping...';
    
    // Start progress polling
    progressInterval = setInterval(updateProgress, 500); // Poll every 500ms
    
    try {
        const response = await fetch('/scrape', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                video_url: document.getElementById('video-url').value,
                max_comments: document.getElementById('max-comments').value,
                include_replies: document.getElementById('include-replies').checked
            })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error);
        
        // Build video info HTML
        let videoInfoHtml = `
            <p><strong>Video:</strong> ${data.video_info ? data.video_info.title : 'N/A'}</p>
            <p><strong>Komentar Diambil:</strong> ${data.total_comments} dari ${data.requested_comments} yang diminta</p>
        `;
        
        // Add available comments info if known
        if (data.available_comments > 0) {
            videoInfoHtml += `<p><strong>Total Komentar di Video:</strong> ${data.available_comments}</p>`;
        }
        
        document.getElementById('video-info').innerHTML = videoInfoHtml;
        
        // Show warning if got less than requested
        if (data.warning) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'alert';
            warningDiv.style.background = '#fff3cd';
            warningDiv.style.color = '#856404';
            warningDiv.style.borderLeft = '4px solid #ffc107';
            warningDiv.style.marginBottom = '15px';
            warningDiv.innerHTML = `<strong>⚠️ Info:</strong> ${data.warning}`;
            document.getElementById('video-info').insertBefore(warningDiv, document.getElementById('video-info').firstChild);
        }
        
        // Show save message
        document.getElementById('save-message').textContent = 
            `Data berhasil disimpan sebagai: ${data.saved_filename}`;
        document.getElementById('save-message').style.display = 'block';
        
        document.getElementById('result-section').style.display = 'block';
    } catch (error) {
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('error-message').style.display = 'block';
    } finally {
        // Stop progress polling
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('scrape-btn').disabled = false;
    }
});
</script>
{% endblock %}
